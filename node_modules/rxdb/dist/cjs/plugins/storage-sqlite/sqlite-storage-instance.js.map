{"version":3,"file":"sqlite-storage-instance.js","names":["_index","require","_rxjs","_sqliteHelpers","_rxQueryHelper","_rxError","instanceId","RxStorageInstanceSQLite","exports","storage","databaseName","collectionName","schema","internals","options","settings","tableName","devMode","changes$","Subject","openWriteCount$","BehaviorSubject","opCount","sqliteBasics","primaryPath","getPrimaryFieldOfPrimaryKey","primaryKey","_proto","prototype","run","db","queryWithParams","ensureParamsCountIsCorrect","all","newRxError","bulkWrite","documentWrites","context","next","getValue","database","databasePromise","ret","error","writePromises","categorized","sqliteTransaction","closed","Error","result","query","params","method","data","docsInDb","Map","forEach","docSQLResult","doc","JSON","parse","getDataFromResultRow","id","set","categorizeBulkWriteRows","errors","length","bulkInsertDocs","row","insertQuery","getSQLiteInsertSQL","document","push","bulkUpdateDocs","updateQuery","getSQLiteUpdateSQL","Promise","eventBulk","events","lastState","ensureNotFalsy","newestRow","checkpoint","lwt","_meta","originalPreparedQuery","skip","limit","Infinity","skipPlusLimit","queryMatcher","getQueryMatcher","subResult","docData","sortComparator","getSortComparator","sort","slice","documents","count","results","mode","findDocumentsById","ids","withDeleted","i","resultRow","includes","_deleted","changeStream","asObservable","cleanup","minimumDeletedTime","promiseWait","minTimestamp","Date","getTime","getAttachmentData","_documentId","_attachmentId","remove","promises","close","queue","TX_QUEUE_BY_DATABASE","get","firstValueFrom","pipe","filter","v","resolve","catch","complete","closeDatabaseConnection","createSQLiteTrialStorageInstance","version","attachments","useDatabaseName","databaseNamePrefix","getDatabaseConnection","then","tableQuery","indexCreation","instance","addRxStorageMultiInstanceSupport","RX_STORAGE_NAME_SQLITE"],"sources":["../../../../src/plugins/storage-sqlite/sqlite-storage-instance.ts"],"sourcesContent":["import {\n    RxJsonSchema,\n    RxStorageInstanceCreationParams,\n    RxStorageInstance,\n    getPrimaryFieldOfPrimaryKey,\n    EventBulk,\n    RxStorageChangeEvent,\n    RxDocumentData,\n    BulkWriteRow,\n    RxStorageBulkWriteResponse,\n    RxStorageQueryResult,\n    categorizeBulkWriteRows,\n    ensureNotFalsy,\n    StringKeys,\n    addRxStorageMultiInstanceSupport,\n    RxStorageDefaultCheckpoint,\n    CategorizeBulkWriteRowsOutput,\n    RxStorageCountResult,\n    promiseWait,\n    getQueryMatcher,\n    PreparedQuery\n} from '../../index.ts';\nimport { BehaviorSubject, Observable, Subject, filter, firstValueFrom } from 'rxjs';\nimport type { RxStorageSQLiteTrial } from './index.ts';\nimport {\n    closeDatabaseConnection,\n    ensureParamsCountIsCorrect,\n    getDatabaseConnection,\n    getSQLiteUpdateSQL,\n    RX_STORAGE_NAME_SQLITE,\n    sqliteTransaction,\n    getDataFromResultRow,\n    getSQLiteInsertSQL,\n    TX_QUEUE_BY_DATABASE\n} from './sqlite-helpers.ts';\nimport type {\n    SQLiteBasics,\n    SQLiteInstanceCreationOptions,\n    SQLiteInternals,\n    SQLiteQueryWithParams,\n    SQLiteStorageSettings\n} from './sqlite-types.ts';\nimport { getSortComparator } from '../../rx-query-helper.ts';\nimport { newRxError } from '../../rx-error.ts';\n\nlet instanceId = 0;\nexport class RxStorageInstanceSQLite<RxDocType> implements RxStorageInstance<\n    RxDocType,\n    SQLiteInternals,\n    SQLiteInstanceCreationOptions,\n    RxStorageDefaultCheckpoint\n> {\n    public readonly primaryPath: StringKeys<RxDocType>;\n    private changes$: Subject<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>, RxStorageDefaultCheckpoint>> = new Subject();\n    public readonly instanceId = instanceId++;\n    public closed?: Promise<void>;\n\n    public sqliteBasics: SQLiteBasics<any>;\n\n    public readonly openWriteCount$ = new BehaviorSubject(0);\n\n\n    private opCount = 0;\n\n    constructor(\n        public readonly storage: RxStorageSQLiteTrial,\n        public readonly databaseName: string,\n        public readonly collectionName: string,\n        public readonly schema: Readonly<RxJsonSchema<RxDocumentData<RxDocType>>>,\n        public readonly internals: SQLiteInternals,\n        public readonly options: Readonly<SQLiteInstanceCreationOptions>,\n        public readonly settings: SQLiteStorageSettings,\n        public readonly tableName: string,\n        public readonly devMode: boolean\n    ) {\n        this.sqliteBasics = storage.settings.sqliteBasics;\n        this.primaryPath = getPrimaryFieldOfPrimaryKey(this.schema.primaryKey) as any;\n    }\n\n\n    run(\n        db: any,\n        queryWithParams: SQLiteQueryWithParams\n    ) {\n        if (this.devMode) {\n            ensureParamsCountIsCorrect(queryWithParams);\n        }\n        return this.sqliteBasics.run(db, queryWithParams);\n    }\n    all(\n        db: any,\n        queryWithParams: SQLiteQueryWithParams\n    ) {\n        if (this.devMode) {\n            ensureParamsCountIsCorrect(queryWithParams);\n        }\n\n        this.opCount = this.opCount + 1;\n        if (this.opCount > 110) {\n            throw newRxError('SQL3');\n        }\n\n        return this.sqliteBasics.all(db, queryWithParams);\n    }\n\n    /**\n     * @link https://medium.com/@JasonWyatt/squeezing-performance-from-sqlite-insertions-971aff98eef2\n     */\n    async bulkWrite(\n        documentWrites: BulkWriteRow<RxDocType>[],\n        context: string\n    ): Promise<RxStorageBulkWriteResponse<RxDocType>> {\n        this.openWriteCount$.next(this.openWriteCount$.getValue() + 1);\n        const database = await this.internals.databasePromise;\n        const ret: RxStorageBulkWriteResponse<RxDocType> = {\n            error: []\n        };\n        const writePromises: Promise<any>[] = [];\n        let categorized: CategorizeBulkWriteRowsOutput<RxDocType> = {} as any;\n\n        await sqliteTransaction(\n            database,\n            this.sqliteBasics,\n            async () => {\n                if (this.closed) {\n                    this.openWriteCount$.next(this.openWriteCount$.getValue() - 1);\n                    throw new Error('SQLite.bulkWrite(' + context + ') already closed ' + this.tableName + ' context: ' + context);\n                }\n                const result = await this.all(\n                    database,\n                    {\n                        query: `SELECT data FROM \"${this.tableName}\"`,\n                        params: [],\n                        context: {\n                            method: 'bulkWrite',\n                            data: documentWrites\n                        }\n                    }\n                );\n\n                const docsInDb: Map<RxDocumentData<RxDocType>[StringKeys<RxDocType>], RxDocumentData<RxDocType>> = new Map();\n                result.forEach(docSQLResult => {\n                    const doc = JSON.parse(getDataFromResultRow(docSQLResult));\n                    const id = doc[this.primaryPath];\n                    docsInDb.set(id, doc);\n                });\n                categorized = categorizeBulkWriteRows(\n                    this,\n                    this.primaryPath,\n                    docsInDb,\n                    documentWrites,\n                    context\n                );\n                ret.error = categorized.errors;\n\n                if ((result.length + categorized.bulkInsertDocs.length) > 300) {\n                    throw newRxError('SQL2');\n                }\n\n                categorized.bulkInsertDocs.forEach(row => {\n                    const insertQuery = getSQLiteInsertSQL(\n                        this.tableName,\n                        this.primaryPath as any,\n                        row.document\n                    );\n                    writePromises.push(\n                        this.all(\n                            database,\n                            {\n                                query: insertQuery.query,\n                                params: insertQuery.params,\n                                context: {\n                                    method: 'bulkWrite',\n                                    data: categorized\n                                }\n                            }\n                        )\n                    );\n                });\n\n                categorized.bulkUpdateDocs.forEach(row => {\n                    const updateQuery = getSQLiteUpdateSQL<RxDocType>(\n                        this.tableName,\n                        this.primaryPath,\n                        row\n                    );\n                    writePromises.push(\n                        this.run(\n                            database,\n                            updateQuery\n                        )\n                    );\n                });\n\n                await Promise.all(writePromises);\n\n                // close transaction\n                if (this.closed) {\n                    this.openWriteCount$.next(this.openWriteCount$.getValue() - 1);\n                    return 'ROLLBACK';\n                } else {\n                    this.openWriteCount$.next(this.openWriteCount$.getValue() - 1);\n                    return 'COMMIT';\n                }\n            },\n            {\n                databaseName: this.databaseName,\n                collectionName: this.collectionName\n            }\n        );\n\n        if (categorized && categorized.eventBulk.events.length > 0) {\n            const lastState = ensureNotFalsy(categorized.newestRow).document;\n            categorized.eventBulk.checkpoint = {\n                id: lastState[this.primaryPath],\n                lwt: lastState._meta.lwt\n            };\n            this.changes$.next(categorized.eventBulk);\n        }\n\n        return ret;\n    }\n\n\n    async query(\n        originalPreparedQuery: PreparedQuery<RxDocType>\n    ): Promise<RxStorageQueryResult<RxDocType>> {\n\n        const database = await this.internals.databasePromise;\n\n\n\n        let result: RxDocumentData<RxDocType>[] = [];\n        const query = originalPreparedQuery.query;\n        const skip = query.skip ? query.skip : 0;\n        const limit = query.limit ? query.limit : Infinity;\n        const skipPlusLimit = skip + limit;\n        const queryMatcher = getQueryMatcher(\n            this.schema,\n            query as any\n        );\n        const subResult = await this.all(\n            database,\n            {\n                query: 'SELECT data FROM \"' + this.tableName + '\"',\n                params: [],\n                context: {\n                    method: 'query',\n                    data: originalPreparedQuery\n                }\n            }\n        );\n        subResult.forEach(row => {\n            const docData = JSON.parse(getDataFromResultRow(row));\n            if (queryMatcher(docData)) {\n                result.push(docData);\n            }\n        });\n        const sortComparator = getSortComparator(this.schema, query as any);\n        result = result.sort(sortComparator);\n        result = result.slice(skip, skipPlusLimit);\n        return {\n            documents: result\n        };\n    }\n    async count(\n        originalPreparedQuery: PreparedQuery<RxDocType>\n    ): Promise<RxStorageCountResult> {\n        const results = await this.query(originalPreparedQuery);\n        return {\n            count: results.documents.length,\n            mode: 'fast'\n        };\n    }\n\n\n    async findDocumentsById(\n        ids: string[],\n        withDeleted: boolean\n    ): Promise<RxDocumentData<RxDocType>[]> {\n        const database = await this.internals.databasePromise;\n\n        if (this.closed) {\n            throw new Error('SQLite.findDocumentsById() already closed ' + this.tableName + ' context: ' + context);\n        }\n\n        const result = await this.all(\n            database,\n            {\n                query: `SELECT data FROM \"${this.tableName}\"`,\n                params: [],\n                context: {\n                    method: 'findDocumentsById',\n                    data: ids\n                }\n            }\n        );\n        const ret: RxDocumentData<RxDocType>[] = [];\n        for (let i = 0; i < result.length; ++i) {\n            const resultRow = result[i];\n            const doc: RxDocumentData<RxDocType> = JSON.parse(getDataFromResultRow(resultRow));\n            if (\n                ids.includes((doc as any)[this.primaryPath]) &&\n                (\n                    withDeleted || !doc._deleted\n                )\n            ) {\n                ret.push(doc);\n            }\n        }\n        return ret;\n    }\n\n    changeStream(): Observable<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>, RxStorageDefaultCheckpoint>> {\n        return this.changes$.asObservable();\n    }\n\n    async cleanup(minimumDeletedTime: number): Promise<boolean> {\n        await promiseWait(0);\n        await promiseWait(0);\n        const database = await this.internals.databasePromise;\n\n        /**\n         * Purge deleted documents\n         */\n        const minTimestamp = new Date().getTime() - minimumDeletedTime;\n        await this.all(\n            database,\n            {\n                query: `\n                    DELETE FROM\n                        \"${this.tableName}\"\n                    WHERE\n                        deleted = 1\n                        AND\n                        lastWriteTime < ?\n                `,\n                params: [\n                    minTimestamp\n                ],\n                context: {\n                    method: 'cleanup',\n                    data: minimumDeletedTime\n                }\n            }\n        );\n        return true;\n    }\n\n    async getAttachmentData(_documentId: string, _attachmentId: string): Promise<string> {\n        throw newRxError('SQL1');\n    }\n\n    async remove(): Promise<void> {\n        if (this.closed) {\n            throw new Error('closed already');\n        }\n        const database = await this.internals.databasePromise;\n        const promises = [\n            this.run(\n                database,\n                {\n                    query: `DROP TABLE IF EXISTS \"${this.tableName}\"`,\n                    params: [],\n                    context: {\n                        method: 'remove',\n                        data: this.tableName\n                    }\n                }\n            )\n        ];\n        await Promise.all(promises);\n        return this.close();\n    }\n\n    async close(): Promise<void> {\n        const queue = TX_QUEUE_BY_DATABASE.get(await this.internals.databasePromise);\n        if (queue) {\n            await queue;\n        }\n\n        if (this.closed) {\n            return this.closed;\n        }\n        this.closed = (async () => {\n            await firstValueFrom(this.openWriteCount$.pipe(filter(v => v === 0)));\n            const database = await this.internals.databasePromise;\n\n            /**\n             * First get a transaction\n             * to ensure currently running operations\n             * are finished\n             */\n            await sqliteTransaction(\n                database,\n                this.sqliteBasics,\n                () => {\n                    return Promise.resolve('COMMIT');\n                }\n            ).catch(() => { });\n            this.changes$.complete();\n            await closeDatabaseConnection(\n                this.databaseName,\n                this.storage.settings.sqliteBasics\n            );\n        })();\n        return this.closed;\n\n    }\n}\n\nexport async function createSQLiteTrialStorageInstance<RxDocType>(\n    storage: RxStorageSQLiteTrial,\n    params: RxStorageInstanceCreationParams<RxDocType, SQLiteInstanceCreationOptions>,\n    settings: SQLiteStorageSettings\n): Promise<RxStorageInstanceSQLite<RxDocType>> {\n    const sqliteBasics = settings.sqliteBasics;\n    const tableName = params.collectionName + '-' + params.schema.version;\n\n\n    if (params.schema.attachments) {\n        throw newRxError('SQL1');\n    }\n\n    const internals: Partial<SQLiteInternals> = {};\n    const useDatabaseName = (settings.databaseNamePrefix ? settings.databaseNamePrefix : '') + '_trial_' + params.databaseName;\n    internals.databasePromise = getDatabaseConnection(\n        storage.settings.sqliteBasics,\n        useDatabaseName\n    ).then(async (database) => {\n        await sqliteTransaction(\n            database,\n            sqliteBasics,\n            async () => {\n                const tableQuery = `\n                CREATE TABLE IF NOT EXISTS \"${tableName}\"(\n                    id TEXT NOT NULL PRIMARY KEY UNIQUE,\n                    revision TEXT,\n                    deleted BOOLEAN NOT NULL CHECK (deleted IN (0, 1)),\n                    lastWriteTime INTEGER NOT NULL,\n                    data json\n                );\n                `;\n                await sqliteBasics.run(\n                    database,\n                    {\n                        query: tableQuery,\n                        params: [],\n                        context: {\n                            method: 'createSQLiteStorageInstance create tables',\n                            data: params.databaseName\n                        }\n                    }\n                );\n                return 'COMMIT';\n            },\n            {\n                indexCreation: false,\n                databaseName: params.databaseName,\n                collectionName: params.collectionName\n            }\n        );\n        return database;\n    });\n\n    const instance = new RxStorageInstanceSQLite(\n        storage,\n        params.databaseName,\n        params.collectionName,\n        params.schema,\n        internals as any,\n        params.options,\n        settings,\n        tableName,\n        params.devMode\n    );\n\n    await addRxStorageMultiInstanceSupport(\n        RX_STORAGE_NAME_SQLITE,\n        params,\n        instance\n    );\n\n    return instance;\n}\n"],"mappings":"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","ignoreList":[]}