{"version":3,"file":"mongodb-helper.js","names":["_rxError","require","_index","startChangeStream","mongoCollection","resumeToken","errorSubject","changeStream","watch","resumeAfter","on","err","emitError","newRxError","errors","toArray","map","er","errorToPlainJson","next","mongodbDocToRxDB","primaryPath","doc","_id","document","useDoc","flatClone","_deleted","rxdbDocToMongo","ret","_meta","_attachments"],"sources":["../../../../src/plugins/replication-mongodb/mongodb-helper.ts"],"sourcesContent":["import { Subject } from 'rxjs';\nimport { RxError, RxTypeError, newRxError } from '../../rx-error.ts';\nimport {\n    errorToPlainJson,\n    flatClone,\n    toArray\n} from '../utils/index.ts';\nimport type {\n    MongoDBChangeStreamResumeToken\n} from './mongodb-types';\nimport {\n    Collection as MongoCollection,\n    ChangeStream,\n    WithId\n} from 'mongodb';\nimport type { RxDocumentData, WithDeleted } from '../../types/rx-storage';\n\nexport async function startChangeStream(\n    mongoCollection: MongoCollection<any>,\n    resumeToken?: MongoDBChangeStreamResumeToken,\n    errorSubject?: Subject<RxError | RxTypeError>\n): Promise<ChangeStream> {\n    const changeStream = mongoCollection.watch([], resumeToken ? { resumeAfter: resumeToken } : {\n\n    });\n\n    if (errorSubject) {\n        changeStream.on('error', (err: any) => {\n            const emitError = newRxError('RC_STREAM', {\n                errors: toArray(err).map(er => errorToPlainJson(er))\n            });\n            errorSubject.next(emitError);\n        });\n    }\n    return changeStream;\n}\n\n\nexport function mongodbDocToRxDB<DocType>(primaryPath: string, doc: WithId<DocType>): WithDeleted<DocType> {\n    if (primaryPath === '_id' && typeof doc._id !== 'string') {\n        throw newRxError('MG1', {\n            document: doc\n        });\n    }\n\n    const useDoc: any = flatClone(doc);\n    useDoc._deleted = false;\n\n    if (primaryPath === '_id') {\n        return useDoc;\n    } else {\n        delete useDoc._id;\n        return useDoc;\n    }\n}\n\n\n/**\n * MongoDB operations like mongoCollection.updateOne() will mutate the input!\n * So we have to flat-clone first here.\n * Also we do not want to store RxDB-specific metadata in the mongodb database.\n */\nexport function rxdbDocToMongo<DocType>(doc: RxDocumentData<DocType>): DocType {\n    const ret: any = flatClone(doc);\n    delete ret._deleted;\n    delete ret._meta;\n    delete ret._attachments;\n    return ret;\n}\n"],"mappings":";;;;;;;;AACA,IAAAA,QAAA,GAAAC,OAAA;AACA,IAAAC,MAAA,GAAAD,OAAA;AAeO,eAAeE,iBAAiBA,CACnCC,eAAqC,EACrCC,WAA4C,EAC5CC,YAA6C,EACxB;EACrB,IAAMC,YAAY,GAAGH,eAAe,CAACI,KAAK,CAAC,EAAE,EAAEH,WAAW,GAAG;IAAEI,WAAW,EAAEJ;EAAY,CAAC,GAAG,CAE5F,CAAC,CAAC;EAEF,IAAIC,YAAY,EAAE;IACdC,YAAY,CAACG,EAAE,CAAC,OAAO,EAAGC,GAAQ,IAAK;MACnC,IAAMC,SAAS,GAAG,IAAAC,mBAAU,EAAC,WAAW,EAAE;QACtCC,MAAM,EAAE,IAAAC,cAAO,EAACJ,GAAG,CAAC,CAACK,GAAG,CAACC,EAAE,IAAI,IAAAC,uBAAgB,EAACD,EAAE,CAAC;MACvD,CAAC,CAAC;MACFX,YAAY,CAACa,IAAI,CAACP,SAAS,CAAC;IAChC,CAAC,CAAC;EACN;EACA,OAAOL,YAAY;AACvB;AAGO,SAASa,gBAAgBA,CAAUC,WAAmB,EAAEC,GAAoB,EAAwB;EACvG,IAAID,WAAW,KAAK,KAAK,IAAI,OAAOC,GAAG,CAACC,GAAG,KAAK,QAAQ,EAAE;IACtD,MAAM,IAAAV,mBAAU,EAAC,KAAK,EAAE;MACpBW,QAAQ,EAAEF;IACd,CAAC,CAAC;EACN;EAEA,IAAMG,MAAW,GAAG,IAAAC,gBAAS,EAACJ,GAAG,CAAC;EAClCG,MAAM,CAACE,QAAQ,GAAG,KAAK;EAEvB,IAAIN,WAAW,KAAK,KAAK,EAAE;IACvB,OAAOI,MAAM;EACjB,CAAC,MAAM;IACH,OAAOA,MAAM,CAACF,GAAG;IACjB,OAAOE,MAAM;EACjB;AACJ;;AAGA;AACA;AACA;AACA;AACA;AACO,SAASG,cAAcA,CAAUN,GAA4B,EAAW;EAC3E,IAAMO,GAAQ,GAAG,IAAAH,gBAAS,EAACJ,GAAG,CAAC;EAC/B,OAAOO,GAAG,CAACF,QAAQ;EACnB,OAAOE,GAAG,CAACC,KAAK;EAChB,OAAOD,GAAG,CAACE,YAAY;EACvB,OAAOF,GAAG;AACd","ignoreList":[]}